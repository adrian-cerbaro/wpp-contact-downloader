/*! wpp-contact-downloader 2020-03-21 */

$(document).ready(function(){chrome.runtime.onConnect.addListener(e=>{"default-conn"==e.name&&e.onMessage.addListener(t=>{"loadData"==t.command&&async function(){let e=$(".X7YrQ ._2UaNq._3mMX1"),t={profile_pic:e.find("img.jZhyM._13Xdg._F7Vk").attr("src"),name:e.find("._2WP9Q ._3NWy8 span").attr("title")},n=[];return $(".FTBzM").filter(function(){return $(this).find("._2qE0x.copyable-text").find("._3RWII").find("img").length}).each(function(){let e=$(this).find("img").attr("src")||"",t=new URL(e).searchParams.get("u").replace(/\D+/g,"")||"",i={profile_pic:e,name:$(this).find(".nUQs8 ._2LRBk.selectable-text").text(),number:t,email:""};n.push(i)}),await Promise.all($(".FTBzM").filter(function(){return $(this).find(".CqLtL").find("._3j7-G").length}).map(async function(){$(this).find("._1PENu .Ir_Ne").click();let e=$(".app-wrapper-web").find("span ._2t4Ic").first(),t=e.find("header .qfKkX");e.css("display","none"),await async function(e){let t=[];return await Promise.all($(e).find(".rK2ei ._1v8mQ").map(async function(){let e=$(this),n={profile_pic:"",name:e.find("._3H4MS span").attr("title"),number:"",email:""};await e.onAvailable("img").then(e=>{n.profile_pic=e.attr("src")});let i=e.find("._1VwzF ._22OEK ._F7Vk").first().text();/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(i).toLowerCase())?n.email=i:n.number=i.replace(/\D+/g,""),t.push(n),console.log(n)})),t}(e).then(e=>{$.merge(n,e)}),t.click()})),{user:t,contact_list:n}}().then(t=>e.postMessage({command:"updateData",data:t}))})})}),$.fn.onAvailable=function(e,t={}){let n=$.extend({},{wait_time:50,max_tries:70},t);return new Promise((t,i)=>{let a,r=this;if(this.find(e).length)t(this.find(e));else{let s=0;a=setInterval(()=>{let l=r.find(e);l.length?(t(l),clearInterval(a)):s==n.max_tries&&i(),s++},n.wait_time)}})};